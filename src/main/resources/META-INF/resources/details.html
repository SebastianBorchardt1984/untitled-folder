<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Details</title>
    <link rel="stylesheet" href="/app/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        .details-container, .progress-container {
            display: flex;
            flex-wrap: wrap;
        }
        .detail-item, .progress-item {
            flex: 1 1 45%; /* Adjust the width of each item */
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .detail-item strong, .progress-item strong {
            display: block;
            margin-bottom: 5px;
        }
        .state-active {
            color: blue;
        }
        .state-completed {
            color: green;
        }
        .state-error, .state-abort {
            color: red;
        }
        .state-default {
            color: black;
        }
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-left: 20px;
        }
        .progress-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .progress-item img {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <button id="back-button">Zur√ºck</button>
    <h1>Details Page</h1>
    <div id="content-container">
        <div id="details-container">
            <h2>Details</h2>
            <div id="details-content"></div>
        </div>
        <div id="diagram-container">
            <h2>Prozessablauf</h2>
            <div id="diagram-content"></div>
            <div id="zoom-controls">
                <button id="zoom-in">+</button>
                <button id="zoom-out">-</button>
                <span id="zoom-level">100%</span>
            </div>
        </div>
        <div id="progress-container" class="details-container">
            <h2>Fortschritt</h2>
            <div id="progress-content"></div>
        </div>
    </div>
    <div id="variables-container">
        <h2>Prozessdaten</h2>
        <div id="variables-content"></div>
    </div>
    <div id="action-buttons">
        <select id="nodes-dropdown" class="dropdown"></select>
        <button id="skip-button" class="bottom-right-button">Skip Process</button>
        <button id="abort-button" class="bottom-right-button">Abort</button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            fetch(`/graphql`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify({ 
                    query: `{
                        ProcessInstances(where: {id: {equal: "${id}"}}) {
                            id
                            processId
                            processName
                            businessKey
                            state
                            parentProcessInstance {
                                id
                                processName
                            }
                            rootProcessId
                            rootProcessInstanceId
                            childProcessInstances {
                                id
                                processName
                            }
                            serviceUrl
                            variables
                            nodes {
                                id
                                name
                                type
                                exit
                                definitionId
                            }
                            diagram
                        }
                    }`
                })
            })
            .then(response => response.json())
            .then(data => {
                const instance = data.data.ProcessInstances[0];
                const diagramContent = document.getElementById('diagram-content');
                const detailsContent = document.getElementById('details-content');
                const progressContent = document.getElementById('progress-content');
                const variablesContent = document.getElementById('variables-content');

                // Display the SVG diagram
                diagramContent.innerHTML = instance.diagram;

                // Function to get state class
                function getStateClass(state) {
                    switch(state) {
                        case 'ACTIVE': return 'state-active';
                        case 'COMPLETED': return 'state-completed';
                        case 'ERROR': return 'state-error';
                        case 'ABORT': return 'state-abort';
                        default: return 'state-default';
                    }
                }

                // Display the details
                const details = [
                    { label: 'ID', value: instance.id },
                    { label: 'Process Name', value: instance.processName },
                    { label: 'State', value: instance.state, className: getStateClass(instance.state) },
                    { label: 'Business Key', value: instance.businessKey },
                    { label: 'Root Process ID', value: instance.rootProcessId },
                    { label: 'Root Process Instance ID', value: instance.rootProcessInstanceId, isLink: true }
                ];

                if (instance.parentProcessInstance) {
                    details.push(
                        { label: 'Parent Process Instance ID', value: instance.parentProcessInstance.id, isLink: true },
                        { label: 'Parent Process Name', value: instance.parentProcessInstance.processName }
                    );
                }

                if (Array.isArray(instance.childProcessInstances)) {
                    instance.childProcessInstances.forEach(child => {
                        details.push(
                            { label: 'Child Process Instance ID', value: child.id, isLink: true },
                            { label: 'Child Process Name', value: child.processName }
                        );
                    });
                }

                detailsContent.innerHTML = `<div class="details-container">` + details
                    .filter(detail => detail.value !== null)
                    .map(detail => {
                        if (detail.isLink) {
                            return `<div class="detail-item"><strong>${detail.label}:</strong> <a href="/details.html?id=${detail.value}">${detail.value}</a></div>`;
                        } else if (detail.className) {
                            return `<div class="detail-item"><strong>${detail.label}:</strong> <span class="${detail.className}">${detail.value}</span></div>`;
                        } else {
                            return `<div class="detail-item"><strong>${detail.label}:</strong> ${detail.value}</div>`;
                        }
                    })
                    .join('') + `</div>`;

                // Display the progress
                const sortedNodes = instance.nodes.sort((a, b) => new Date(a.exit) - new Date(b.exit));
                progressContent.innerHTML = sortedNodes.map(node => `
                    <div class="progress-item">
                        <img src="/app/quarkus-logo.png" alt="Icon" />
                        <span>${node.name}</span>
                    </div>
                `).join('');

                // Display the variables as a collapsible tree
                function createTree(data, parentElement) {
                    const ul = document.createElement('ul');
                    for (const key in data) {
                        const li = document.createElement('li');
                        if (typeof data[key] === 'object' && data[key] !== null) {
                            li.innerHTML = `<span class="caret"><strong>${key}</strong></span>`;
                            createTree(data[key], li);
                        } else {
                            li.innerHTML = `<span><strong>${key}:</strong> <span class="value">${data[key]}</span></span>`;
                        }
                        ul.appendChild(li);
                    }
                    parentElement.appendChild(ul);
                }

                createTree(instance.variables, variablesContent);

                // Add zoom functionality
                const svgElement = diagramContent.querySelector('svg');
                let zoomLevel = 1;

                document.getElementById('zoom-in').addEventListener('click', function() {
                    zoomLevel *= 1.1;
                    svgElement.setAttribute('transform', `scale(${zoomLevel})`);
                    document.getElementById('zoom-level').innerText = `${Math.round(zoomLevel * 100)}%`;
                });

                document.getElementById('zoom-out').addEventListener('click', function() {
                    zoomLevel /= 1.1;
                    svgElement.setAttribute('transform', `scale(${zoomLevel})`);
                    document.getElementById('zoom-level').innerText = `${Math.round(zoomLevel * 100)}%`;
                });

                // Add collapsible functionality
                const toggler = document.getElementsByClassName('caret');
                for (let i = 0; i < toggler.length; i++) {
                    toggler[i].addEventListener('click', function() {
                        this.parentElement.querySelector('ul').classList.toggle('active');
                        this.classList.toggle('caret-down');
                    });
                }

                // Fetch and populate nodes dropdown
                fetch(`/management/processes/${instance.processId}/nodes`, {
                    method: 'GET',
                    headers: {
                        'Accept': '*/*',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const dropdown = document.getElementById('nodes-dropdown');
                    data.forEach(node => {
                        if (node.metadata && node.metadata.elementname) {
                            const option = document.createElement('option');
                            option.value = node.metadata.elementname;
                            option.text = node.metadata.elementname;
                            dropdown.appendChild(option);
                        }
                    });
                })
                .catch(error => console.error('Error fetching nodes:', error));

                // Add skip functionality
                document.getElementById('skip-button').addEventListener('click', function() {
                    const skipUrl = `${instance.serviceUrl}/management/processes/${instance.processId}/instances/${instance.id}/skip`;
                    fetch(skipUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Process instance skipped successfully.');
                        } else {
                            alert(`Failed to skip process instance. Endpoint: ${skipUrl}`);
                        }
                    })
                    .catch(error => console.error(`Error skipping process instance. Endpoint: ${skipUrl}`, error));
                });

                // Add abort functionality
                document.getElementById('abort-button').addEventListener('click', function() {
                    const abortUrl = `${instance.serviceUrl}/${instance.processId}/${instance.id}`;
                    fetch(abortUrl, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json',
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Process instance aborted successfully.');
                        } else {
                            alert(`Failed to abort process instance. Endpoint: ${abortUrl}`);
                        }
                    })
                    .catch(error => console.error(`Error aborting process instance. Endpoint: ${abortUrl}`, error));
                });
            })
            .catch(error => {
                console.error('Error fetching process instance data:', error.message);
                alert(`An error occurred: ${error.message}`);
            });

            document.getElementById('back-button').addEventListener('click', function() {
                window.location.href = '/app';
            });
        });
    </script>
</body>
</html>